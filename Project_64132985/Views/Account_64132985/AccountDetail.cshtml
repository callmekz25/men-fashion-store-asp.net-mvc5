
@model Project_64132985.Models.Customer
@{
    ViewBag.Title = "Hồ sơ tài khoản";
   
    var emailRegex = @"/\S+@\S+\.\S+/";
}

<style>
    .flex-child {
        flex: 0 0 100%;
    }

    input:focus {
        box-shadow: 0 0 8px rgb(45 123 230 / 60%)
    }

    input {
        transition: 0.3s ease
    }
    .scroll-slides {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
</style>
<div>
    <div class="flex items-center bg-[#f6f6f6] px-6 py-10 lg:px-[100px] lg:py-[60px]">
        <div class="flex flex-col gap-2" data-aos="fade-right">
            <span class="font-semibold text-[22px] lg:text-[19px]">Hồ sơ tài khoản</span>
           
        </div>
    </div>
    <div class="mt-[60px] bg-white px-6 lg:px-[100px]">
        <div class="flex flex-col gap-10 lg:flex-row">
            @*Phần menu*@
            <ul class="scroll-slides flex max-w-full flex-row gap-3 overflow-x-scroll lg:w-[200px] lg:flex-col lg:gap-3 lg:py-[60px]">
                <li class="">
                    <a href=@Url.Action("Index", "Account_64132985") class="flex min-w-[140px] items-center gap-2 px-3 py-3 opacity-70 hover:cursor-pointer hover:text-black lg:py-2">
                        <ion-icon name="cart-outline" class="text-black text-[23px] lg:text-[25px]"></ion-icon>
                        <span class="font-medium text-[17px] lg:text-[14px]">Đơn mua</span>
                    </a>
                </li>
                <li class="">
                    <a href=@Url.Action("Address", "Account_64132985") class="flex min-w-[140px] items-center gap-2 rounded px-3 py-3 opacity-70 transition-all duration-300 hover:cursor-pointer hover:text-black hover:opacity-100 lg:py-2">
                        <ion-icon name="person-outline" class="text-black text-[23px] lg:text-[25px]"></ion-icon>
                        <span class="font-medium text-[17px] lg:text-[14px]">Thông tin</span>
                    </a>
                </li>
                <li class="">
                    <a href=@Url.Action("ChangePassword", "Account_64132985") class="flex min-w-[140px] items-center gap-2 rounded px-3 py-3 opacity-70 transition-all duration-300 hover:cursor-pointer hover:text-black hover:opacity-100 lg:py-2">
                        <ion-icon name="key-outline" class="text-black text-[23px] lg:text-[25px]"></ion-icon>
                        <span class="font-medium text-[17px] lg:text-[14px]">Mật khẩu</span>
                    </a>
                </li>
                <li class="">
                    <a href=@Url.Action("AccountDetail", "Account_64132985") class="flex min-w-[140px] items-center gap-2 rounded px-3 py-3 text-black opacity-100 transition-all duration-300 hover:cursor-pointer hover:text-black hover:opacity-100 lg:py-2">
                        <ion-icon name="mail-outline" class="text-black text-[23px] lg:text-[25px]"></ion-icon>
                        <span class="font-medium text-[17px] lg:text-[14px]">Email</span>
                    </a>
                </li>
                <li class="">
                    <a href=@Url.Action("Logout", "Home_64132985") class="flex min-w-[140px] items-center gap-2 rounded px-3 py-3 opacity-70 transition-all duration-300 hover:cursor-pointer hover:text-black hover:opacity-100 lg:py-2">
                        <ion-icon name="log-out-outline" class="text-black text-[23px] lg:text-[25px]"></ion-icon>
                        <span class="font-medium text-[17px] lg:text-[14px]">Đăng xuất</span>
                    </a>
                </li>
            </ul>
            <div class="hidden h-[500px] w-[1px] bg-gray-200 lg:block"></div>
            @*Phần detail của menu*@
            <div>
                <span class="font-medium lg:text-[18px]">Địa chỉ email</span>
                <div class="mt-4 py-[30px]">
                    <div class="flex max-w-[350px] overflow-hidden px-2">
                        <div class="flex-child account-ui flex flex-grow flex-col gap-4 transition-all duration-300">
                            <div class="flex flex-col gap-1">
                                <label for="email" class="text-[#474B57] lg:text-[14px]">Email</label>
                                <input id="email" type="email" placeholder="Email của bạn" value="@Model.Email" class="border-200 w-full rounded border px-3 py-2 outline-none lg:text-[14px]" />
                                <span class="error-email text-red-500 lg:text-[13px]"></span>
                            </div>
                            <button disabled class="opacity-60 save mt-8 w-fit rounded bg-black px-5 py-2 text-white lg:text-[13px]">Thay đổi</button>
                        </div>
                        <div class="verify-ui opacity-0 flex-child flex flex-grow flex-col items-center gap-2 overflow-hidden transition-all duration-300">
                            <div class="flex items-center gap-2">
                                <span class="font-semibold lg:text-[23px]">Xác thực tài khoản</span>
                            </div>
                            <span class="to-email mt-2 max-w-[100%] text-wrap break-words text-center text-[#474B57] lg:text-[13px]"></span>
                            <input type="text" class="mt-4 min-w-[200px] rounded border border-gray-300 px-2 py-2" id="code" />
                            <span class="error-code mt-1 text-red-500 lg:text-[13px]"></span>
                            <div class="mt-1 flex items-center gap-2 lg:text-[12px]">
                                <span class="text-[#474B57]">Bạn không nhận được mã xác thực</span>
                                <button class="send-code-again text-blue-500 underline hover:cursor-pointer">Gửi lại mã xác thực</button>
                            </div>
                            <button class="verify mt-4 rounded bg-black px-8 py-2.5 font-medium text-white lg:text-[14px]">Xác thực</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
@section AccountDetail{

    <script>
        document.addEventListener("DOMContentLoaded", () => {

            const accountDetailUi = document.querySelector(".account-ui");
            const verifyUi = document.querySelector(".verify-ui");

            const btnSave = document.querySelector(".save");
            const btnVerify = document.querySelector(".verify");

          
           
            const email = document.querySelector("#email");
            const errorEmail = document.querySelector(".error-email");
            const emailRegex = new RegExp(@emailRegex);
            const toEmail = document.querySelector(".to-email")
            const errorCode = document.querySelector(".error-code");
            const btnSendCodeAgain = document.querySelector(".send-code-again");
            const authCode = document.querySelector("#code");
            let code = "";


            // Hàm ẩn email khi gửi mã xác thực
              @Html.Raw("function hiddenEmail(email) " +
             "{ const [name, domain] = email.split('@'); " +
             "const hiddenName = name.slice(0, 3) + '*'.repeat(name.length - 3); " +
             "return hiddenName + '@' + domain; }")


            email.addEventListener("input", () => {
                errorEmail.textContent = "";
                email.classList.remove("border-[#fc3939]", "bg-[#fff2f4]");
                btnSave.disabled = false;
                btnSave.classList.remove("opacity-60");
               
            })

           


            btnSave.addEventListener("click", () => {

                let flag = false;
                if (email.value === "") {
                    errorEmail.textContent = "Email không được trống";
                    flag = true;
                    email.classList.add("border-[#fc3939]", "bg-[#fff2f4]");
                }
                else if (!emailRegex.test(email.value)) {
                    errorEmail.textContent = "Email không hợp lệ";
                    flag = true;
                    email.classList.add("border-[#fc3939]", "bg-[#fff2f4]");
                }
                else {
                    errorEmail.textContent = "";

                    email.classList.remove("border-[#fc3939]", "bg-[#fff2f4]");
                }
                if (!flag) {
                    btnSave.classList.add("opacity-60");
                    btnSave.disabled = true;
                    btnSave.textContent = "Đang xử lý...";
                    fetch("/Account_64132985/SendCodeChangeEmail", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            email: email.value,
                        })
                    }).then((response) => response.json())
                        .then((data) => {
                            if (data.success) {
                                btnSave.classList.remove("opacity-60");
                                btnSave.disabled = false;
                                btnSave.textContent = "Thay đổi";
                                toEmail.textContent = `Mã xác thực đã được gửi tới ${hiddenEmail(email.value)}`;
                                accountDetailUi.classList.add("translate-x-[-100%]", "opacity-0", "scale-0");
                                verifyUi.classList.add("translate-x-[-100%]", "opacity-100");
                                code = data.authCode;
                            }
                        })
                }

            })

            btnSendCodeAgain.addEventListener("click", () => {
                btnSendCodeAgain.disabled = true;
                fetch("/Account_64132985/SendCodeChangeEmail", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email.value,
                    })
                }).then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            code = data.authCode;
                            Toastify({
                                text: "Đã gửi lại mã xác thực",
                                className: "info",
                                position: "center",
                                duration: 2000,
                               
                                avatar: "https://static.vecteezy.com/system/resources/thumbnails/017/350/123/small_2x/green-check-mark-icon-in-round-shape-design-png.png",
                                style: {
                                    background: "white",
                                    color: "black",
                                    display: "flex",
                                    alignItems: "center",
                                    gap: "10px",
                                    fontSize: "16px",

                                },

                            }).showToast();
                            btnSendCodeAgain.disabled = false;
                        } else {
                            Toastify({
                                text: "Lỗi khi gửi lại mã xác thực",
                                className: "info",
                                position: "center",
                                duration: 2000,
                                avatar: "https://as1.ftcdn.net/v2/jpg/01/45/20/02/1000_F_145200273_450ViYipr5uU3WIwqzwjsRDHYTMcUH9P.jpg",
                             
                                style: {
                                    background: "white",
                                    color: "black",
                                    display: "flex",
                                    alignItems: "center",
                                    gap: "10px",
                                    fontSize: "16px",

                                },

                            }).showToast();
                            btnSendCodeAgain.disabled = false;
                        }
                    })
            })


            btnVerify.addEventListener("click", () => {
                let flag = false;
                if (authCode.value === "") {
                    errorCode.textContent = "Mã xác thực không được trống";
                    flag = true;
                    authCode.classList.add("border-[#fc3939]", "bg-[#fff2f4]");
                }
                else if (authCode.value !== code) {
                    errorCode.textContent = "Mã xác thực không khớp";
                    flag = true;
                    authCode.classList.add("border-[#fc3939]", "bg-[#fff2f4]");
                } else {
                    errorCode.textContent = "";
                    authCode.classList.remove("border-[#fc3939]", "bg-[#fff2f4]");
                    if (!flag) {
                        btnVerify.classList.add("opacity-60");
                        btnVerify.textContent = "Đang xử lý...";
                        btnVerify.disabled = true
                        fetch("/Account_64132985/UpdateEmail", {
                            method: "POST",
                            headers: {
                                'Content-Type': "application/json"
                            },
                            body: JSON.stringify({
                                email: email.value,
                            })
                        }).then((response) => response.json())
                            .then((data) => {
                                if (data.success) {
                                    btnVerify.classList.remove("opacity-60");
                                    btnVerify.textContent = "Thay đổi";
                                    btnVerify.disabled = false
                                    fetch("/Home_64132985/Logout").then((response) => {
                                        if (response.ok) {
                                            window.location.href = "/Login"
                                        }
                                    })
                                }
                            })
                    }
                }
            })

        })

    </script>


}
