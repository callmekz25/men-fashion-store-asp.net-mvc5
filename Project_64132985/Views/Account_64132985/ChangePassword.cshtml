@model Project_64132985.Models.Customer
@{
    ViewBag.Title = "Hồ sơ tài khoản";
}
<style>
    .flex-child {
        flex: 0 0 100%;
    }

    input:focus {
        box-shadow: 0 0 8px rgb(45 123 230 / 60%)
    }

    input {
        transition: 0.3s ease
    }
    .scroll-slides {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
</style>

<div>
    <div class="flex items-center bg-[#f6f6f6] px-6 py-10 lg:px-[100px] lg:py-[60px]">
        <div class="flex flex-col gap-2" data-aos="fade-right">
            <span class="font-semibold text-[22px] lg:text-[19px]">Hồ sơ tài khoản</span>
        </div>
    </div>
    <div class="mt-[60px] bg-white px-6 lg:px-[100px]">
        <div class="flex flex-col gap-10 lg:flex-row">
            @*Phần menu*@
            <ul class="scroll-slides flex max-w-full flex-row gap-3 overflow-x-scroll lg:w-[200px] lg:flex-col lg:gap-3 lg:py-[60px]">
                <li class="">
                    <a href=@Url.Action("Index", "Account_64132985") class="flex min-w-[140px] items-center gap-2 px-3 py-3 opacity-70 hover:cursor-pointer hover:text-black lg:py-2">
                        <ion-icon name="cart-outline" class="text-black text-[23px] lg:text-[25px]"></ion-icon>
                        <span class="font-medium text-[17px] lg:text-[14px]">Đơn mua</span>
                    </a>
                </li>
                <li class="">
                    <a href=@Url.Action("Address", "Account_64132985") class="flex min-w-[140px] items-center gap-2 px-3 py-3 text-black opacity-70 transition-all duration-300 hover:cursor-pointer hover:text-black lg:py-2">
                        <ion-icon name="person-outline" class="text-black text-[23px] lg:text-[25px]"></ion-icon>
                        <span class="font-medium text-[17px] lg:text-[14px]">Thông tin</span>
                    </a>
                </li>
                <li class="">
                    <a href=@Url.Action("ChangePassword", "Account_64132985") class="flex min-w-[140px] items-center gap-2 rounded px-3 py-3 opacity-100 transition-all duration-300 hover:cursor-pointer hover:text-black hover:opacity-100 lg:py-2">
                        <ion-icon name="key-outline" class="text-black text-[23px] lg:text-[25px]"></ion-icon>
                        <span class="font-medium text-[17px] lg:text-[14px]">Mật khẩu</span>
                    </a>
                </li>
                <li class="">
                    <a href=@Url.Action("AccountDetail", "Account_64132985") class="flex min-w-[140px] items-center gap-2 rounded px-3 py-3 opacity-70 transition-all duration-300 hover:cursor-pointer hover:text-black hover:opacity-100 lg:py-2">
                        <ion-icon name="mail-outline" class="text-black text-[23px] lg:text-[25px]"></ion-icon>
                        <span class="font-medium text-[17px] lg:text-[14px]">Email</span>
                    </a>
                </li>
                <li class="">
                    <a href=@Url.Action("Logout", "Home_64132985") class="flex min-w-[140px] items-center gap-2 rounded px-3 py-3 opacity-70 transition-all duration-300 hover:cursor-pointer hover:text-black hover:opacity-100 lg:py-2">
                        <ion-icon name="log-out-outline" class="text-black text-[23px] lg:text-[25px]"></ion-icon>
                        <span class="font-medium text-[17px] lg:text-[14px]">Đăng xuất</span>
                    </a>
                </li>
            </ul>
            <div class="hidden h-[500px] w-[1px] bg-gray-200 lg:block"></div>
            @*Phần detail của menu*@
            <div>
                <span class="font-medium lg:text-[18px]">Thay đổi mật khẩu</span>
                <div class="mt-4 flex max-w-[350px] overflow-hidden px-2 py-[30px]">
                    <div class="change-password-ui flex-child flex flex-grow flex-col gap-6 transition-all duration-300">
                        <div class="flex flex-col gap-1">
                            <label class="text-[#474B57] lg:text-[14px]" for="curr-password">Mật khẩu hiện tại</label>
                            <div class="relative">
                                <input id="curr-password" type="password" placeholder="Mật khẩu hiện tại của bạn" class="w-full rounded-md border border-gray-300 px-2 py-2 outline-none lg:text-[14px]" />
                                <ion-icon name="eye-off-outline" id="toggle-curr-password" class="translate-y-[-50%] absolute right-3 top-[50%] size-4 hover:cursor-pointer"></ion-icon>
                            </div>

                            <span class="error-curr-password text-red-500 lg:text-[13px]"></span>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label for="new-password" class="text-[#474B57] lg:text-[14px]">Mật khẩu mới</label>
                            <div class="relative">
                                <input id="new-password" type="password" placeholder="Mật khẩu mới của bạn" class="w-full rounded-md border border-gray-300 px-2 py-2 outline-none lg:text-[14px]" />
                                <ion-icon name="eye-off-outline" id="toggle-new-password" class="translate-y-[-50%] absolute right-3 top-[50%] size-4 hover:cursor-pointer"></ion-icon>
                            </div>

                            <span class="error-new-password text-red-500 lg:text-[13px]"></span>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label for="replace-new-password" class="text-[#474B57] lg:text-[14px]">Nhập lại mật khẩu</label>
                            <div class="relative">
                                <input id="replace-new-password" type="password" placeholder="Nhập lại mật khẩu" class="w-full rounded-md border border-gray-300 px-2 py-2 outline-none lg:text-[14px]" />
                                <ion-icon name="eye-off-outline" id="toggle-replace-new-password" class="translate-y-[-50%] absolute right-3 top-[50%] size-4 hover:cursor-pointer"></ion-icon>
                            </div>

                            <span class="error-replace-new-password text-red-500 lg:text-[13px]"></span>
                        </div>
                        <button disabled class="change-password opacity-60 mt-2 w-fit rounded bg-black px-5 py-2 font-medium text-white lg:text-[13px]" data-email="@Model.Email">Thay đổi</button>
                    </div>
                    <div class="verify-ui opacity-0 flex-child flex flex-grow flex-col items-center gap-2 overflow-hidden transition-all duration-300">
                        <div class="flex items-center gap-2">
                            <span class="font-semibold lg:text-[25px]">Xác thực tài khoản</span>
                        </div>
                        <span class="to-email mt-2 max-w-[100%] text-wrap break-words text-center text-[#474B57] lg:text-[14px]"></span>
                        <input type="text" class="mt-4 min-w-[200px] rounded border border-gray-300 px-2 py-2" id="code" />
                        <span class="error-code mt-1 text-red-500 lg:text-[13px]"></span>
                        <div class="mt-1 flex items-center gap-2 lg:text-[12px]">
                            <span class="text-[#474B57]">Bạn không nhận được mã xác thực</span>
                            <button class="send-code-again text-blue-500 underline hover:cursor-pointer">Gửi lại mã xác thực</button>
                        </div>
                        <button class="verify mt-4 rounded bg-black px-8 py-2.5 font-medium text-white lg:text-[14px]">Xác thực</button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

@section ChangePassword{
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const changePasswordUi = document.querySelector(".change-password-ui");
            const verifyUi = document.querySelector(".verify-ui");
            const btnChangePassword = document.querySelector(".change-password");
            const btnVerify = document.querySelector(".verify");
            const currentPassword = document.querySelector("#curr-password");
            const errorCurrentPassword = document.querySelector(".error-curr-password");
            const newPassword = document.querySelector("#new-password");
            const errorNewPassword = document.querySelector(".error-new-password");
            const replaceNewPassword = document.querySelector("#replace-new-password");
            const errorReplaceNewPassword = document.querySelector(".error-replace-new-password");
            const codeInput = document.querySelector("#code");
            const errorCode = document.querySelector(".error-code");
            const toggleCurrentPassword = document.querySelector("#toggle-curr-password");
            const toggleNewPassword = document.querySelector("#toggle-new-password");
            const toggleReplaceNewPassword = document.querySelector("#toggle-replace-new-password");

            const btnSendCodeAgain = document.querySelector(".send-code-again");


            const toEmail = document.querySelector(".to-email");

               // Hàm ẩn email khi gửi mã xác thực
             @Html.Raw("function hiddenEmail(email) " +
            "{ const [name, domain] = email.split('@'); " +
            "const hiddenName = name.slice(0, 3) + '*'.repeat(name.length - 3); " +
            "return hiddenName + '@' + domain; }")

            let email = "";

            toggleCurrentPassword.addEventListener("click", () => {
                if (currentPassword.type === "password") {
                    currentPassword.type = "text";
                    toggleCurrentPassword.setAttribute("name", "eye-outline");
                } else {
                    currentPassword.type = "password";
                    toggleCurrentPassword.setAttribute("name", "eye-off-outline");
                }
            })

            toggleNewPassword.addEventListener("click", () => {
                if (newPassword.type === "password") {
                    newPassword.type = "text";
                    toggleNewPassword.setAttribute("name", "eye-outline");
                } else {
                    newPassword.type = "password";
                    toggleNewPassword.setAttribute("name", "eye-off-outline");
                }
            })

            toggleReplaceNewPassword.addEventListener("click", () => {
                if (replaceNewPassword.type === "password") {
                    replaceNewPassword.type = "text";
                    toggleReplaceNewPassword.setAttribute("name", "eye-outline");
                } else {
                    replaceNewPassword.type = "password";
                    toggleReplaceNewPassword.setAttribute("name", "eye-off-outline");
                }
            })

            currentPassword.addEventListener("input", () => {
                btnChangePassword.classList.remove("opacity-60");
                btnChangePassword.disabled = false
                errorCurrentPassword.textContent = "";
                currentPassword.classList.remove("border-[#fc3939]", "bg-[#fff2f4]");
            })

            newPassword.addEventListener("input", () => {
                btnChangePassword.classList.remove("opacity-60");
                btnChangePassword.disabled = false
                errorNewPassword.textContent = "";
                newPassword.classList.remove("border-[#fc3939]", "bg-[#fff2f4]");
            })

            replaceNewPassword.addEventListener("input", () => {
                btnChangePassword.classList.remove("opacity-60");
                btnChangePassword.disabled = false
                errorReplaceNewPassword.textContent = "";
                replaceNewPassword.classList.remove("border-[#fc3939]", "bg-[#fff2f4]");
            })


            codeInput.addEventListener("input", () => {
                errorCode.textContent = "";
                codeInput.classList.remove("border-[#fc3939]", "bg-[#fff2f4]");
            })

            let code = "";
            // Xử lý khi bấm thay đổi mật khẩu
            btnChangePassword.addEventListener("click", () => {

                let flag = false;
                if (currentPassword.value === "") {
                    errorCurrentPassword.textContent = "Mật khẩu hiện tại không được trống";
                    currentPassword.classList.add("border-[#fc3939]", "bg-[#fff2f4]");
                    flag = true;
                } else {
                    errorCurrentPassword.textContent = "";
                    currentPassword.classList.remove("border-[#fc3939]", "bg-[#fff2f4]");
                }
                if (newPassword.value === "") {
                    errorNewPassword.textContent = "Mật khẩu mới không được trống";
                    newPassword.classList.add("border-[#fc3939]", "bg-[#fff2f4]");
                    flag = true;
                } else if (newPassword.value.length < 6) {
                    errorNewPassword.textContent = "Mật khẩu yêu cầu tối thiểu 6 kí tự";
                    flag = true
                    newPassword.classList.add("border-[#fc3939]", "bg-[#fff2f4]");
                } else {
                    errorNewPassword.textContent = ""
                    newPassword.classList.remove("border-[#fc3939]", "bg-[#fff2f4]");
                }
                if (replaceNewPassword.value === "") {
                    errorReplaceNewPassword.textContent = "Nhập lại mật khẩu của bạn";
                    flag = true;
                    replaceNewPassword.classList.add("border-[#fc3939]", "bg-[#fff2f4]");
                } else if (replaceNewPassword.value !== newPassword.value) {
                    errorReplaceNewPassword.textContent = "Mật khẩu không khớp với mật khẩu mới";
                    flag = true;
                    replaceNewPassword.classList.add("border-[#fc3939]", "bg-[#fff2f4]");
                } else {
                    errorReplaceNewPassword.textContent = "";
                    replaceNewPassword.classList.remove("border-[#fc3939]", "bg-[#fff2f4]");
                }
                if (!flag) {
                    btnChangePassword.classList.add("opacity-60");
                    btnChangePassword.disabled = true;
                    btnChangePassword.textContent = "Đang xử lý...";
                    fetch("/Account_64132985/CheckPassword", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            password: currentPassword.value,
                        })
                    }).then((response) => response.json())
                        .then((data) => {
                            if (!data.success) {
                                errorCurrentPassword.textContent = data.message;
                                currentPassword.classList.add("border-[#fc3939]", "bg-[#fff2f4]");
                                btnChangePassword.classList.remove("opacity-60");
                                btnChangePassword.disabled = false;
                                btnChangePassword.textContent = "Thay đổi";
                            } else {
                                email = btnChangePassword.getAttribute("data-email");
                                fetch("/Account_64132985/SendCodeChangePassword", {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        email: email,
                                    })
                                }).then((response) => response.json())
                                    .then((data) => {
                                        if (data.success) {
                                            code = data.authCode;
                                            toEmail.textContent = `Mã xác thực đã được gửi tới ${hiddenEmail(email)}`;
                                            changePasswordUi.classList.add("translate-x-[-100%]", "opacity-0", "scale-0");
                                            verifyUi.classList.add("translate-x-[-100%]", "opacity-100");
                                        }
                                        btnChangePassword.classList.remove("opacity-60");
                                        btnChangePassword.disabled = false;
                                        btnChangePassword.textContent = "Thay đổi";
                                    })
                            }

                        })
                }
            })


            // Xử lí khi bấm xác thực code để thay đổi mật khẩu
            btnVerify.addEventListener("click", () => {
                btnVerify.classList.add("opacity-60");
                btnVerify.disabled = true;
                btnVerify.textContent = "Đang xác thực...";
                if (codeInput.value === "") {
                    errorCode.textContent = "Mã xác thực không được trống";
                    codeInput.classList.add("border-[#fc3939]", "bg-[#fff2f4]");
                    btnVerify.classList.remove("opacity-60");
                    btnVerify.disabled = false;
                    btnVerify.textContent = "Xác thực";
                } else {
                    if (codeInput.value !== code) {
                        errorCode.textContent = "Mã xác thực không đúng";
                        codeInput.classList.add("border-[#fc3939]", "bg-[#fff2f4]");
                        btnVerify.classList.remove("opacity-60");
                        btnVerify.disabled = false;
                        btnVerify.textContent = "Xác thực";
                    } else {

                        errorCode.textContent = "";
                        codeInput.classList.remove("border-[#fc3939]", "bg-[#fff2f4]");

                        fetch("/Account_64132985/UpdatePassword", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                password: newPassword.value,
                            })
                        }).then((response) => response.json())
                            .then((data) => {
                                if (data.success) {
                                    btnVerify.classList.remove("opacity-60");
                                    btnVerify.disabled = false;
                                    btnVerify.textContent = "Xác thực";
                                    fetch("/Home_64132985/Logout").then((response) => {
                                        if (response.ok) {
                                            window.location.href = "/Login"
                                        }
                                    })
                                } else {
                                    console.log("Fail to update password")
                                    btnVerify.classList.remove("opacity-60");
                                    btnVerify.disabled = false;
                                    btnVerify.textContent = "Xác thực";
                                }
                            })
                    }

                }
            })

            btnSendCodeAgain.addEventListener("click", () => {
                fetch("/Account_64132985/SendCodeChangePassword", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                    })
                }).then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            code = data.authCode;
                            Toastify({
                                text: "Đã gửi lại mã xác thực",
                                className: "info",
                                position: "center",
                                duration: 2000,
                                //avatar: "https://as1.ftcdn.net/v2/jpg/01/45/20/02/1000_F_145200273_450ViYipr5uU3WIwqzwjsRDHYTMcUH9P.jpg",
                                avatar: "https://static.vecteezy.com/system/resources/thumbnails/017/350/123/small_2x/green-check-mark-icon-in-round-shape-design-png.png",
                                style: {
                                    background: "white",
                                    color: "black",
                                    display: "flex",
                                    alignItems: "center",
                                    gap: "10px",
                                    fontSize: "16px",

                                },

                            }).showToast();
                        } else {
                            Toastify({
                                text: "Lỗi xảy ra",
                                className: "info",
                                position: "center",
                                duration: 2000,
                                avatar: "https://as1.ftcdn.net/v2/jpg/01/45/20/02/1000_F_145200273_450ViYipr5uU3WIwqzwjsRDHYTMcUH9P.jpg",
                                //avatar: "https://static.vecteezy.com/system/resources/thumbnails/017/350/123/small_2x/green-check-mark-icon-in-round-shape-design-png.png",
                                style: {
                                    background: "white",
                                    color: "black",
                                    display: "flex",
                                    alignItems: "center",
                                    gap: "10px",
                                    fontSize: "16px",

                                },

                            }).showToast();
                        }
                    })
            })
        })

    </script>


}